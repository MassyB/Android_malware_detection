import re, os
from apk import APK
from utils import *

#Const

PERMISSION = 'permission'
FEATURE = 'feature'
INTENT = 'intent'
ACTIVITY = 'activity'
SERVICE = 'service'
RECEIVER = 'receiver'
PROVIDER = 'provider'

MANIFEST_FEATURES = [PERMISSION, FEATURE, INTENT, ACTIVITY, SERVICE, RECEIVER, PROVIDER]

PATTERN = 'E: uses-permission(.*?)A: android:name(.*?)="(?P<'+PERMISSION+'>.*?)"|' \
          'E: uses-feature(.*?)A: android:name(.*?)="(?P<'+FEATURE+'>.*?)"|' \
          'E: intent-filter(.*?)E: action(.*?)A: android:name(.*?)="(?P<'+INTENT+'>.*?)"|' \
          'E: activity(.*?)A: android:name(.*?)="(?P<'+ACTIVITY+'>.*?)"|' \
          'E: service(.*?)A: android:name(.*?)="(?P<'+SERVICE+'>.*?)"|' \
          'E: provider(.*?)A: android:name(.*?)="(?P<'+PROVIDER+'>.*?)"|' \
          'E: receiver(.*?)A: android:name(.*?)="(?P<'+RECEIVER+'>.*?)"'


def extract_manifest_features(apk: 'APK'):
    # call aapt
    execute_aapt(apk.get_path())

    # opening manifest and searching for regex
    with open(AAPT_OUTPUT_MANIFEST, 'r') as manifest_file:
        manifest_content = manifest_file.read().replace('\n', ' ')
        for match in re.finditer(PATTERN, manifest_content): # ToDo multi-line regex
            add_feature(match, apk)


def add_feature(match, apk: 'APK'):
    if match.group(PERMISSION):
        apk.add_defined_permissions(match.group(PERMISSION))
    elif match.group(FEATURE):
        apk.add_hardwares(match.group(FEATURE))
    elif match.group(INTENT):
        apk.add_hardwares(match.group(INTENT))
    elif match.group(ACTIVITY):
        apk.add_activities(match.group(ACTIVITY))
    elif match.group(SERVICE):
        apk.add_services(match.group(SERVICE))
    elif match.group(PROVIDER):
        apk.add_providers(match.group(PROVIDER))
    elif match.group(RECEIVER):
        apk.add_receivers(match.group(RECEIVER))


def run_test(apk_path):
    apk = APK(apk_path, 1)
    extract_manifest_features(apk)
    # Testing
    for f in apk.get_manifest_features().get_features():
        print(f.get('feature_type')+'::'+f.get('feature_name'))