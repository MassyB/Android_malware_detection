import os

from apk import APK
from utils import execute_apktool, APKTOOL_OUTPUT
import xml.etree.ElementTree as etree

# const
android_name_attrib = '{http://schemas.android.com/apk/res/android}name'


def extract_manifest_features(apk: 'APK'):
    execute_apktool(apk.get_path())
    manifest_path = os.path.join(APKTOOL_OUTPUT, "AndroidManifest.xml")
    tree = etree.parse(manifest_path)
    root = tree.getroot()

    root.get('package')
    list_permissions = extract_permissions(root)
    list_hardwares = extract_hardwares(root)
    intent_filters = set()
    list_activities = extract_activities(root, intent_filters)
    list_receivers = extract_receivers(root, intent_filters)
    list_services = extract_services(root, intent_filters)
    list_providers = extract_providers(root)

    apk.add_activities(list_activities)
    apk.add_receivers(list_receivers)
    apk.add_services(list_services)
    apk.add_providers(list_providers)
    apk.add_intents(intent_filters)
    apk.add_hardwares(list_hardwares)
    apk.add_defined_permissions(list_permissions)


def extract_permissions(root):
    list_permissions = set()
    permissions = root.findall("uses-permission")
    for permission in permissions:
        name = permission.get(android_name_attrib)
        list_permissions.add(name)
    return list_permissions


def extract_activities(root, intent_filters=set()):
    list_activities = set()
    application = root.find("application")
    activities = application.findall("activity")
    for activity in activities:
        name = activity.get(android_name_attrib)
        list_activities.add(name)
        get_intents(activity, intent_filters)
    return list_activities


def extract_services(root, intent_filters=set()):
    list_services = set()
    application = root.find("application")
    services = application.findall("service")
    for service in services:
        name = service.get(android_name_attrib)
        list_services.add(name)
        get_intents(service, intent_filters)
    return list_services


def extract_receivers(root, intent_filters=set()):
    list_receivers = set()
    application = root.find("application")
    receivers = application.findall("receiver")
    for receiver in receivers:
        name = receiver.get(android_name_attrib)
        list_receivers.add(name)
        get_intents(receiver, intent_filters)

    return list_receivers


def extract_providers(root):
    list_providers = set()
    application = root.find("application")
    providers = application.findall("provider")
    for provider in providers:
        name = provider.get(android_name_attrib)
        list_providers.add(name)
        # there is no intent filters in providers :p
    return list_providers


def get_intents(component, intent_filters):
    list_filters = component.findall("intent-filter")
    for intent_filter in list_filters:
        actions = intent_filter.findall("action")
        for action in actions:
            name = action.get(android_name_attrib)
            intent_filters.add(name)


def extract_hardwares(root):
    list_hardwares = set()
    features = root.findall("uses-feature")
    for feature in features:
        name = feature.get(android_name_attrib)
        list_hardwares.add(name)
    return list_hardwares
