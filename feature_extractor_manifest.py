import re,os
from apk import APK
from utils import *

#Const

PERMISSION = 'permission'
FEATURE = 'feature'
INTENT = 'intent'
ACTIVITY = 'activity'
SERVICE = 'service'
RECEIVER = 'receiver'
PROVIDER = 'provider'

PATTERN = 'E: uses-permission(.*?)A: android:name(.*?)="(?P<'+PERMISSION+'>.*?)"|' \
          'E: uses-feature(.*?)A: android:name(.*?)="(?P<'+FEATURE+'>.*?)"|' \
          'E: intent-filter(.*?)E: action(.*?)A: android:name(.*?)="(?P<'+INTENT+'>.*?)"|' \
          'E: activity(.*?)A: android:name(.*?)="(?P<'+ACTIVITY+'>.*?)"|' \
          'E: service(.*?)A: android:name(.*?)="(?P<'+SERVICE+'>.*?)"|' \
          'E: provider(.*?)A: android:name(.*?)="(?P<'+PROVIDER+'>.*?)"|' \
          'E: receiver(.*?)A: android:name(.*?)="(?P<'+RECEIVER+'>.*?)"'


list_permissions = set()
list_hardwares = set()
intent_filters = set()
list_activities = set()
list_receivers = set()
list_services = set()
list_providers = set()

def extract_manifest_features(apk: 'APK'):
    #call aapt
    execute_aapt(apk.get_path())



    #opening manifest and searcing for regex
    with open(AAPT_OUTPUT_MANIFEST, 'r') as manifest_file:
        manifest_content = manifest_file.read().replace('\n', ' ')
        for match in re.finditer(PATTERN, manifest_content):
            #print(match.groupdict())
            get_feature(match)


    apk.add_activities(list_activities)
    apk.add_receivers(list_receivers)
    apk.add_services(list_services)
    apk.add_providers(list_providers)
    apk.add_intents(intent_filters)
    apk.add_hardwares(list_hardwares)
    apk.add_defined_permissions(list_permissions)


def get_feature(match):
    if match.group(PERMISSION):
        list_permissions.add(match.group(PERMISSION))
    if match.group(FEATURE):
        list_hardwares.add(match.group(FEATURE))
    if match.group(INTENT):
        intent_filters.add(match.group(INTENT))
    if match.group(ACTIVITY):
        list_activities.add(match.group(ACTIVITY))
    if match.group(SERVICE):
        list_services.add(match.group(SERVICE))
    if match.group(PROVIDER):
        list_providers.add(match.group(PROVIDER))
    if match.group(RECEIVER):
        list_receivers.add(match.group(RECEIVER))


def run_test():
    #apk_path = os.path.join(MALWARE_DATASET_DIR_PATH,'0a0a78000e418ea28fa02e8c162c43396db6141ef8fe876db4027fef04bed663')
    apk_path = os.path.join(BENIGN_DATASET_DIR_PATH,'camera.apk')

    print(apk_path)
    apk = APK(apk_path,1)
    extract_manifest_features(apk)
    #Testing
    for f in apk.get_manifest_features().get_features():
        print(f.get('feature_type')+'::'+f.get('feature_name') )
#run_test()