import os

from apk import APK, ManifestFeatures
from utils import execute_apktool,clean_apktool_output, APKTOOL_OUTPUT
import xml.etree.ElementTree as etree


#const
android_name_attrib = '{http://schemas.android.com/apk/res/android}name'



def extract_manifest_features(apk: 'APK'):
    # results vars
    intent_filters = set()
    list_activities = set()
    list_receivers = set()
    list_permissions = set()
    list_features = set()
    _package_name = ""

    execute_apktool(apk.get_path())
    Manifest_path = os.path.join(APKTOOL_OUTPUT,"AndroidManifest.xml")
    tree = etree.parse(Manifest_path)
    # the root in order to parse the content
    root = tree.getroot()
    # the package name
    # print("--package--------------------------------------")
    _package_name = root.get('package')
    # print ("--permissions---------------------------------")
    permissions = root.findall("uses-permission")
    for permission in permissions:
        name = permission.get(android_name_attrib)
        # print (name)
        list_permissions.add(name)

    # print("--features-------------------------------------")
    features = root.findall("uses-feature")
    for feature in features:
        name = feature.get(android_name_attrib)
        list_features.add(name)

    # print("--activities-----------------------------------")
    application = root.find("application")
    activities = application.findall("activity")
    # print("activities = " + str(len(activities)))

    for activity in activities:
        # print(activity.get(android_name_attrib))
        name = activity.get(android_name_attrib)
        list_activities.add(name)
        # print(name)
        list_filters = activity.findall("intent-filter")
        # print("intents = " + str(len(list_filters)))
        # intent_filters.extend(list_filters)
        for intent_filter in list_filters:
            actions = intent_filter.findall("action")
            # print("actions = " + str(len(actions)))
            for action in actions:
                name = action.get(android_name_attrib)
                # print(name)
                intent_filters.add(name)

    # print("--receivers-----------------------------------")
    receivers = application.findall("receiver")
    # print("receivers = " + str(len(receivers)))
    for receiver in receivers:
        # print(activity.get(android_name_attrib))
        name = receiver.get(android_name_attrib)
        list_receivers.add(name)
        # print(name)
        list_filters = receiver.findall("intent-filter")
        for intent_filter in list_filters:
            actions = intent_filter.findall("action")
            # print("actions = " + str(len(actions)))
            for action in actions:
                name = action.get(android_name_attrib)
                # print(name)
                intent_filters.add(name)

    apk.add_components(list_activities)
    apk.add_intents(list_filters)
    apk.add_defined_permissions(list_permissions)
    apk.add_hardwares(list_features)