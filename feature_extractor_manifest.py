import os

from apk import APK, ManifestFeatures
from utils import execute_apktool,clean_apktool_output, APKTOOL_OUTPUT
import xml.etree.ElementTree as etree


#const
android_name_attrib = '{http://schemas.android.com/apk/res/android}name'



def extract_manifest_features(apk: 'APK'):

    execute_apktool(apk.get_path())
    Manifest_path = os.path.join(APKTOOL_OUTPUT,"AndroidManifest.xml")
    tree = etree.parse(Manifest_path)
    # the root in order to parse the content
    root = tree.getroot()
    # the package name
    # print("--package--------------------------------------")
    _package_name = root.get('package')
    # print ("--permissions---------------------------------")
    list_permissions = extract_permissions(root)
    apk.add_defined_permissions(list_permissions)
    # print("--features-------------------------------------")
    list_hardwares = extract_hardwares(root)
    apk.add_hardwares(list_hardwares)
    # print("--components&intent-filters-------------------------------------")
    intent_filters = set()
    list_components = extract_components(root,intent_filters)
    apk.add_components(list_components)
    apk.add_intents(intent_filters)

def extract_permissions(root):
    list_permissions = set()
    permissions = root.findall("uses-permission")
    for permission in permissions:
        name = permission.get(android_name_attrib)
        # print (name)
        list_permissions.add(name)
    return list_permissions

def extract_components(root , intent_filters = set()):
    list_components = set()
    application = root.find("application")
    activities = application.findall("activity")
    receivers = application.findall("receiver")


    for activity in activities:
        # print(activity.get(android_name_attrib))
        name = activity.get(android_name_attrib)
        list_components.add(name)
        # print(name)
        list_filters = activity.findall("intent-filter")
        # print("intents = " + str(len(list_filters)))
        # intent_filters.extend(list_filters)
        for intent_filter in list_filters:
            actions = intent_filter.findall("action")
            # print("actions = " + str(len(actions)))
            for action in actions:
                name = action.get(android_name_attrib)
                # print(name)
                intent_filters.add(name)
    for receiver in receivers:
        # print(activity.get(android_name_attrib))
        name = receiver.get(android_name_attrib)
        list_components.add(name)
        # print(name)
        list_filters = receiver.findall("intent-filter")
        for intent_filter in list_filters:
            actions = intent_filter.findall("action")
            # print("actions = " + str(len(actions)))
            for action in actions:
                name = action.get(android_name_attrib)
                # print(name)
                intent_filters.add(name)

    return list_components
def extract_hardwares(root):
    list_hardwares = set()
    features = root.findall("uses-feature")
    for feature in features:
        name = feature.get(android_name_attrib)
        list_hardwares.add(name)
    return list_hardwares