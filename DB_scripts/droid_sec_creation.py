import sql_commands as sql
import csv

API_PERMISSION_MAPPING_CSV_NAME='api_permission_mapping.csv'
SUSPICIOUS_APIS_CSV_NAME='suspicious_apis.csv'


def write_line(file, line):
    file.write(line+'\n')

def get_api_permission_mapping_values(api_permission_mapping_csv_name= API_PERMISSION_MAPPING_CSV_NAME)-> str:
    """ the header is absent in the csv"""
    api_permission_mapping_values = []
    with open(api_permission_mapping_csv_name, 'rt') as f:
        reader = csv.reader(f)
        for row in reader:
            api_item = "'"+row[0]+"'"
            permission_item = "'"+row[1]+"'"
            api_permission_mapping_item = '('+api_item+','+permission_item+')'
            api_permission_mapping_values.append(api_permission_mapping_item)
    return ",\n".join(api_permission_mapping_values) + ";"


def get_suspicious_api_values(suspicious_apis_csv_name= SUSPICIOUS_APIS_CSV_NAME):
    suspicious_api_values = []
    with open(suspicious_apis_csv_name, 'rt') as f:
        reader = csv.reader(f)
        for row in reader:
            api_item = "'"+row[0]+"'"
            suspicious_api_item = '('+api_item+')'
            suspicious_api_values.append(suspicious_api_item)
    return ",\n".join(suspicious_api_values) + ";"




droid_sec_creation_script = open('droid_sec_creation_script.sql','w')
sql_chunks = [sql.BEGIN_TRANSACTION,
              sql.CREATE_SUSPICIOUS_APIS_TABLE, sql.CREATE_API_PERMISSION_MAPPING_TABLE,
              sql.INSERT_SUSPICIOUS_APIS_VALUES, get_suspicious_api_values(),
              sql.INSERT_API_PERMISSION_MAPPING_VALUES, get_api_permission_mapping_values(),
              sql.CREATE_API_PERMISSION_MAPPING_IDX,sql.CREATE_SUSPICIOUS_APIS_IDX,
              sql.COMMIT_TRANSACTION]
for sql_chunk in sql_chunks:
    write_line(droid_sec_creation_script, sql_chunk)
droid_sec_creation_script.close()
